package net.ccbluex.liquidbounce.features.module.modules.exploit

import net.ccbluex.liquidbounce.DarkNya
import net.ccbluex.liquidbounce.event.EventTarget
import net.ccbluex.liquidbounce.event.MoveEvent
import net.ccbluex.liquidbounce.event.PacketEvent
import net.ccbluex.liquidbounce.event.UpdateEvent
import net.ccbluex.liquidbounce.features.module.Module
import net.ccbluex.liquidbounce.features.module.ModuleCategory
import net.ccbluex.liquidbounce.features.module.ModuleInfo
import net.ccbluex.liquidbounce.features.module.modules.combat.KillAura
import net.ccbluex.liquidbounce.features.module.modules.combat.SuperKnockback
import net.ccbluex.liquidbounce.value.BoolValue
import net.ccbluex.liquidbounce.value.FloatValue
import net.minecraft.network.play.client.CPacketConfirmTransaction
import net.minecraft.network.play.client.CPacketPlayer
import net.minecraft.network.play.server.SPacketEntityVelocity

@ModuleInfo(name = "CancelC03", description = "By CatX_feitu", category = ModuleCategory.EXPLOIT)
class CancelC03 : Module(){
    private val waitOnGround = BoolValue("WaitOnGround",false)
    private var jumpAfterDisable = BoolValue("JumpAfterDisable", false)

    private val isSetRange = BoolValue("SetKillAuraRange",false)
    private val rangeValue = FloatValue("Range",5F,0F,7F)
    private val isSetMulti = BoolValue("SetKillAuraMulti",false)
    private val isSetFov = BoolValue("SetKillAuraFOV",false)
    private val isSetOnlyM = BoolValue("SetSkbOnlyMove",false)
    private val isSetOnlyG = BoolValue("SetSkbOnlyGround",false)

    private val isCancelC0F = BoolValue("CancelC0F",false)
    private val isCancelKBPacket = BoolValue("CancelKBPacket",false)

    var range = 0F
    var fov = 0F
    var airbypass = false
    var multi = ""
    var skbOnlyMove = false
    var skbOnlyGround = false

    var realEnable = false

    override fun onEnable() {
        range = 0F
        fov = 0F
        airbypass = false
        multi = ""
        skbOnlyMove = false
        skbOnlyGround = false
        range = (DarkNya.moduleManager[KillAura::class.java] as KillAura).range
        airbypass = (DarkNya.moduleManager[KillAura::class.java] as KillAura).airBypass.get()
        fov = (DarkNya.moduleManager[KillAura::class.java] as KillAura).fovValue.get()
        multi = (DarkNya.moduleManager[KillAura::class.java] as KillAura).targetModeValue.get()

        skbOnlyMove = (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyMoveValue.get()
        skbOnlyGround = (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyGroundValue.get()

        (DarkNya.moduleManager[KillAura::class.java] as KillAura).airBypass.set(false)

        realEnable = !waitOnGround.get()
    }

    override fun onDisable() {
        (DarkNya.moduleManager[KillAura::class.java] as KillAura).range = range
        (DarkNya.moduleManager[KillAura::class.java] as KillAura).airBypass.set(airbypass)
        (DarkNya.moduleManager[KillAura::class.java] as KillAura).fovValue.set(fov)
        (DarkNya.moduleManager[KillAura::class.java] as KillAura).targetModeValue.set(multi)

        (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyGroundValue.set(skbOnlyGround)
        (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyMoveValue.set(skbOnlyMove)
        range = 0F
        airbypass = false
        fov = 0F
        multi = ""

        if (realEnable && jumpAfterDisable.get()) mc!!.player!!.jump()
        realEnable = false
    }

    @EventTarget
    fun onUpdate(event: UpdateEvent){
        if (!realEnable) return
        if (isSetRange.get() && (DarkNya.moduleManager[KillAura::class.java] as KillAura).range != rangeValue.get())
                (DarkNya.moduleManager[KillAura::class.java] as KillAura).range = rangeValue.get()

        if (isSetMulti.get() && (DarkNya.moduleManager[KillAura::class.java] as KillAura).targetModeValue.get() != "Multi")
                (DarkNya.moduleManager[KillAura::class.java] as KillAura).targetModeValue.set("Multi")

        if (isSetFov.get() && (DarkNya.moduleManager[KillAura::class.java] as KillAura).fovValue.get() != 360f)
                (DarkNya.moduleManager[KillAura::class.java] as KillAura).fovValue.set(360f)

        if (isSetOnlyG.get() && (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyGroundValue.get())
                (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyGroundValue.set(false)

        if (isSetOnlyM.get() && (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyMoveValue.get())
                (DarkNya.moduleManager[SuperKnockback::class.java] as SuperKnockback).onlyMoveValue.set(false)
    }
    @EventTarget
    fun onPacket(event: PacketEvent){
        if(!realEnable) return

        // Cancel C03
        if (event.packet is CPacketPlayer) event.cancelEvent()

        // Cancel C0F
        if (isCancelC0F.get() && event.packet is CPacketConfirmTransaction) event.cancelEvent()
        // Cancel KBPacket
        if (isCancelKBPacket.get() && event.packet is SPacketEntityVelocity) event.cancelEvent()

    }
    @EventTarget
    fun onMove(event: MoveEvent){
        if (realEnable) event.zero()

        if (!realEnable && waitOnGround.get() && mc!!.player!!.onGround) realEnable = true
    }
}